<!--pages/family/family.wxml-->
<view class="container">
  <!-- å½“å‰å®¶åº­ -->
  <view class="current-family card" wx:if="{{currentFamily}}">
    <view class="family-header">
      <view class="family-info">
        <text class="family-name">{{currentFamily.name}}</text>
        <text class="family-description" wx:if="{{currentFamily.description}}">{{currentFamily.description}}</text>
        <text class="member-count">{{currentFamily.memberCount}}ä½æˆå‘˜</text>
      </view>
      <view class="family-actions">
        <text class="action-btn" bindtap="showFamilyActions">ç®¡ç†</text>
      </view>
    </view>
    
    <!-- å®¶åº­æˆå‘˜ -->
    <view class="family-members">
      <text class="section-title">å®¶åº­æˆå‘˜</text>
      <view class="member-list">
        <view class="member-item" wx:for="{{familyMembers}}" wx:key="id">
          <image 
            class="member-avatar" 
            src="{{item.avatarDisplayUrl || '/images/user.png'}}" 
            mode="aspectFill" 
            binderror="onAvatarLoadError"
            data-index="{{index}}"
          ></image>
          <view class="member-info">
            <text class="member-name">{{item.nickName || item.username}}</text>
            <text class="member-role">{{item.role === 1 ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'}}</text>
          </view>
          <view class="member-status">
            <text class="join-date">{{item.joinDate}}</text>
          </view>
        </view>
      </view>
      
      <view class="add-member" bindtap="showInviteModal">
        <view class="add-icon">+</view>
        <text class="add-text">é‚€è¯·æˆå‘˜</text>
      </view>
    </view>
  </view>

  <!-- æ— å®¶åº­çŠ¶æ€ -->
  <view class="no-family" wx:else>
    <view class="no-family-icon">ğŸ </view>
    <text class="no-family-text">æ‚¨è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•å®¶åº­</text>
    <view class="family-actions">
      <button class="btn btn-primary" bindtap="showCreateFamilyModal">åˆ›å»ºå®¶åº­</button>
      <button class="btn btn-secondary" bindtap="showJoinFamilyModal">åŠ å…¥å®¶åº­</button>
    </view>
  </view>

  <!-- æˆ‘çš„å®¶åº­åˆ—è¡¨ -->
  <view class="my-families card" wx:if="{{myFamilies.length > 0}}">
    <view class="my-families-header">
      <text class="card-title">æˆ‘çš„å®¶åº­</text>
      <view class="family-actions">
        <text class="action-btn" bindtap="showCreateFamilyModal">åˆ›å»ºå®¶åº­</text>
        <text class="action-btn" bindtap="showJoinFamilyModal">åŠ å…¥å®¶åº­</text>
      </view>
    </view>
    <view class="family-list">
      <view class="family-item {{item.id === currentFamily.id ? 'current' : ''}}" 
            wx:for="{{myFamilies}}" wx:key="id" 
            bindtap="switchFamily" data-family="{{item}}">
        <view class="family-info">
          <text class="family-name">{{item.name}}</text>
          <text class="family-description" wx:if="{{item.description}}">{{item.description}}</text>
          <text class="member-count">{{item.memberCount}}ä½æˆå‘˜</text>
        </view>
        <view class="family-status">
          <text class="current-badge" wx:if="{{item.id === currentFamily.id}}">å½“å‰</text>
          <text class="switch-text" wx:else>åˆ‡æ¢</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å®¶åº­é¢„ç®— -->
  <view class="family-budget card" wx:if="{{currentFamily && budgetSummary}}">
    <view class="budget-header">
      <view class="budget-title-area" bindtap="toggleBudgetDetail">
        <text class="card-title budget-toggle-arrow">æœ¬æœˆé¢„ç®—{{showBudgetDetail ? 'â–²' : 'â–¼'}}</text>
        <!-- <text class="budget-toggle-arrow">{{showBudgetDetail ? 'â–²' : 'â–¼'}}</text> -->
      </view>
      <text class="manage-budget" wx:if="{{canManageCurrentFamily}}" bindtap="manageBudget">ç®¡ç†</text>
    </view>
    <view class="budget-overview">
      <view class="budget-item">
        <text class="budget-label">æ€»é¢„ç®—</text>
        <text class="budget-value">{{budgetSummary.totalBudget}}</text>
      </view>
      <view class="budget-item">
        <text class="budget-label">å·²ä½¿ç”¨</text>
        <text class="budget-value amount-expense">{{budgetSummary.totalUsed}}</text>
      </view>
      <view class="budget-item">
        <text class="budget-label">å‰©ä½™</text>
        <text class="budget-value {{budgetSummary.remaining >= 0 ? 'amount-income' : 'amount-expense'}}">{{budgetSummary.remaining}}</text>
      </view>
    </view>
    <view class="budget-progress">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{Math.min(budgetSummary.usagePercentage, 100)}}%"></view>
      </view>
      <text class="progress-text">{{budgetSummary.usagePercentage}}%</text>
    </view>

    <view class="budget-detail-list" wx:if="{{showBudgetDetail}}">
      <view class="budget-detail-item" wx:for="{{budgetDetails}}" wx:key="categoryId">
        <view class="detail-left">
          <view class="detail-category-icon" style="background-color: {{item.categoryColor}}">
            {{item.categoryIcon || item.categoryName.charAt(0)}}
          </view>
          <text class="detail-category-name">{{item.categoryName}}</text>
        </view>
        <view class="detail-right">
          <text class="detail-amount">é¢„ç®— {{item.budget}}</text>
          <text class="detail-amount used">å·²ç”¨ {{item.spent}}</text>
          <text class="detail-amount {{item.isOverBudget ? 'over-budget' : ''}}">å‰©ä½™ {{item.remaining}}</text>
          <text class="detail-usage">å·²ç”¨ {{item.utilizationRate}}%</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åˆ›å»ºå®¶åº­å¼¹çª— -->
<view class="create-family-modal" wx:if="{{showCreateFamilyModal}}">
  <view class="modal-mask" bindtap="hideCreateFamilyModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">åˆ›å»ºå®¶åº­</text>
      <text class="modal-close" bindtap="hideCreateFamilyModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">å®¶åº­åç§°</text>
        <input class="input-field" type="text" placeholder="è¯·è¾“å…¥å®¶åº­åç§°" value="{{createForm.name}}" bindinput="onCreateNameInput" />
      </view>

      <view class="input-group">
        <text class="input-label">å®¶åº­å†…æ˜µç§°</text>
        <input class="input-field" type="text" placeholder="è¯·è¾“å…¥æ‚¨åœ¨å®¶åº­å†…çš„æ˜µç§°" value="{{createForm.familyname}}" bindinput="onCreateFamilyNameInput" />
      </view>
      
      <view class="input-group">
        <text class="input-label">å®¶åº­æè¿°</text>
        <textarea class="input-textarea" placeholder="ç®€å•æè¿°ä¸€ä¸‹è¿™ä¸ªå®¶åº­ï¼ˆå¯é€‰ï¼‰" value="{{createForm.description}}" bindinput="onCreateDescriptionInput" maxlength="200"></textarea>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideCreateFamilyModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="createFamily" disabled="{{!createForm.name || createLoading}}">
        {{createLoading ? 'åˆ›å»ºä¸­...' : 'åˆ›å»º'}}
      </button>
    </view>
  </view>
</view>

<!-- åŠ å…¥å®¶åº­å¼¹çª— -->
<view class="join-family-modal" wx:if="{{showJoinFamilyModal}}">
  <view class="modal-mask" bindtap="hideJoinFamilyModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">åŠ å…¥å®¶åº­</text>
      <text class="modal-close" bindtap="hideJoinFamilyModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">é‚€è¯·ç </text>
        <input class="input-field" type="text" placeholder="è¯·è¾“å…¥6ä½é‚€è¯·ç " value="{{joinForm.inviteCode}}" bindinput="onJoinCodeInput" maxlength="6" />
      </view>
      <view class="input-group">
        <text class="input-label">å®¶åº­å†…æ˜µç§°</text>
        <input class="input-field" type="text" placeholder="åœ¨å®¶åº­ä¸­æ˜¾ç¤ºçš„æ˜µç§°ï¼ˆå¯é€‰ï¼‰" value="{{joinForm.nickname}}" bindinput="onJoinNicknameInput" maxlength="20" />
      </view>

      <view class="join-tips">
        <text class="tips-text">è¯·å‘å®¶åº­ç®¡ç†å‘˜è·å–é‚€è¯·ç </text>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideJoinFamilyModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="joinFamily" disabled="{{!joinForm.inviteCode || joinLoading}}">
        {{joinLoading ? 'åŠ å…¥ä¸­...' : 'åŠ å…¥'}}
      </button>
    </view>
  </view>
</view>

<!-- é‚€è¯·æˆå‘˜å¼¹çª— -->
<view class="invite-modal" wx:if="{{showInviteModal}}">
  <view class="modal-mask" bindtap="hideInviteModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é‚€è¯·æˆå‘˜</text>
      <text class="modal-close" bindtap="hideInviteModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="invite-code-display">
        <text class="invite-label">é‚€è¯·ç </text>
        <view class="invite-code">
          <text class="code-text">{{inviteCode}}</text>
          <text class="copy-btn" bindtap="copyInviteCode">å¤åˆ¶</text>
        </view>
      </view>
      
      <view class="invite-tips">
        <text class="tips-text">å°†é‚€è¯·ç åˆ†äº«ç»™å®¶åº­æˆå‘˜ï¼Œä»–ä»¬å¯ä»¥é€šè¿‡æ­¤é‚€è¯·ç åŠ å…¥å®¶åº­</text>
        <text class="tips-text">é‚€è¯·ç æœ‰æ•ˆæœŸä¸º7å¤©</text>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-primary" bindtap="shareInviteCode">åˆ†äº«é‚€è¯·ç </button>
    </view>
  </view>
</view>

<!-- å®¶åº­æ“ä½œå¼¹çª— -->
<view class="family-actions-modal" wx:if="{{showFamilyActions}}">
  <view class="modal-mask" bindtap="hideFamilyActions"></view>
  <view class="actions-content">
    <view class="action-item" wx:if="{{canManageCurrentFamily}}" bindtap="editFamily">
      <text class="action-text">ç¼–è¾‘å®¶åº­ä¿¡æ¯</text>
    </view>
    <view class="action-item" bindtap="manageBudget">
      <text class="action-text">é¢„ç®—ç®¡ç†</text>
    </view>
    <view class="action-item" bindtap="manageMembers">
      <text class="action-text">æˆå‘˜åˆ—è¡¨</text>
    </view>
    <view class="action-item danger" wx:if="{{canManageCurrentFamily}}" bindtap="deleteFamily">
      <text class="action-text">åˆ é™¤å®¶åº­</text>
    </view>
    <view class="action-item danger" wx:if="{{!canManageCurrentFamily}}" bindtap="leaveFamily">
      <text class="action-text">é€€å‡ºå®¶åº­</text>
    </view>
    <view class="action-item" bindtap="hideFamilyActions">
      <text class="action-text">å–æ¶ˆ</text>
    </view>
  </view>
</view>