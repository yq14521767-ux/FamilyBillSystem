<!--pages/statistics/statistics.wxml-->
<view class="container">
  <!-- 时间选择 -->
  <view class="time-selector">
    <view class="time-tabs">
      <view class="time-tab {{timeType === 'month' ? 'active' : ''}}" bindtap="switchTimeType" data-type="month">
        月度
      </view>
      <view class="time-tab {{timeType === 'year' ? 'active' : ''}}" bindtap="switchTimeType" data-type="year">
        年度
      </view>
    </view>
    
    <view class="time-picker" bindtap="showTimePicker">
      <text class="time-text">{{timeText}}</text>
      <text class="time-arrow">▼</text>
    </view>
  </view>

  <!-- 总览卡片 -->
  <view class="overview-card card">
    <view class="overview-header">
      <text class="card-title">{{timeText}}概览</text>
    </view>
    <view class="overview-content">
      <view class="overview-item">
        <text class="overview-label">总收入</text>
        <text class="overview-value amount-income">+{{overview.totalIncome}}</text>
      </view>
      <view class="overview-item">
        <text class="overview-label">总支出</text>
        <text class="overview-value amount-expense">-{{overview.totalExpense}}</text>
      </view>
      <view class="overview-item">
        <text class="overview-label">结余</text>
        <text class="overview-value {{overview.balance >= 0 ? 'amount-income' : 'amount-expense'}}">{{overview.balance >= 0 ? '+' : ''}}{{overview.balance}}</text>
      </view>
    </view>
  </view>

  <!-- 图表切换 -->
  <view class="chart-tabs">
    <view class="chart-tab {{chartType === 'category' ? 'active' : ''}}" bindtap="switchChartType" data-type="category">
      分类统计
    </view>
    <view class="chart-tab {{chartType === 'trend' ? 'active' : ''}}" bindtap="switchChartType" data-type="trend">
      趋势分析
    </view>
  </view>

  <!-- 分类统计 -->
  <view class="category-stats" wx:if="{{chartType === 'category'}}">
    <!-- 收支切换 -->
    <view class="type-tabs">
      <view class="type-tab {{statsType === 'expense' ? 'active expense' : ''}}" bindtap="switchStatsType" data-type="expense">
        支出分析
      </view>
      <view class="type-tab {{statsType === 'income' ? 'active income' : ''}}" bindtap="switchStatsType" data-type="income">
        收入分析
      </view>
    </view>

    <!-- 饼图区域 -->
    <view class="chart-container card">
      <canvas class="pie-chart" canvas-id="pieChart" disable-scroll="true"></canvas>
      <view class="chart-center" wx:if="{{categoryStats.length === 0}}">
        <text class="no-data-text">暂无数据</text>
      </view>
    </view>

    <!-- 分类列表 -->
    <view class="category-list card" wx:if="{{categoryStats.length > 0}}">
      <view class="list-header">
        <text class="card-title">分类明细</text>
        <text class="total-amount">总计: {{statsType === 'expense' ? '-' : '+'}}{{categoryTotal}}</text>
      </view>
      <view class="category-item" wx:for="{{categoryStats}}" wx:key="categoryId">
        <view class="category-info">
          <view class="category-icon" style="background-color: {{item.color}}">
            {{item.icon || item.categoryName.charAt(0)}}
          </view>
          <view class="category-details">
            <text class="category-name">{{item.categoryName}}</text>
            <text class="category-count">{{item.billCount}}笔</text>
          </view>
        </view>
        <view class="category-amount">
          <text class="amount {{statsType === 'expense' ? 'amount-expense' : 'amount-income'}}">
            {{statsType === 'expense' ? '-' : '+'}}{{item.amount}}
          </text>
          <text class="percentage">{{item.percentage}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 趋势分析 -->
  <view class="trend-stats" wx:if="{{chartType === 'trend'}}">
    <!-- 折线图区域 -->
    <view class="chart-container card">
      <canvas class="line-chart" canvas-id="lineChart" disable-scroll="true"></canvas>
      <view class="chart-center" wx:if="{{trendData.length === 0}}">
        <text class="no-data-text">暂无数据</text>
      </view>
    </view>

    <!-- 趋势数据 -->
    <view class="trend-list card" wx:if="{{trendData.length > 0}}">
      <text class="card-title">{{timeType === 'month' ? '每日' : '每月'}}明细</text>
      <view class="trend-item" wx:for="{{trendData}}" wx:key="period">
        <view class="trend-period">
          <text class="period-text">{{item.period}}</text>
        </view>
        <view class="trend-amounts">
          <view class="trend-amount">
            <text class="amount-label">收入</text>
            <text class="amount amount-income">+{{item.income}}</text>
          </view>
          <view class="trend-amount">
            <text class="amount-label">支出</text>
            <text class="amount amount-expense">-{{item.expense}}</text>
          </view>
          <view class="trend-amount">
            <text class="amount-label">结余</text>
            <text class="amount {{item.balance >= 0 ? 'amount-income' : 'amount-expense'}}">{{item.balance >= 0 ? '+' : ''}}{{item.balance}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 预算对比 -->
  <view class="budget-comparison card" wx:if="{{timeType === 'month' && budgetData.length > 0}}">
    <view class="list-header">
      <text class="card-title">预算执行情况</text>
    </view>
    
    <view class="budget-item" wx:for="{{budgetData}}" wx:key="categoryId">
      <view class="budget-header">
        <view class="budget-category">
          <view class="category-icon" style="background-color: {{item.color}}">
            {{item.icon || item.categoryName.charAt(0)}}
          </view>
          <text class="category-name">{{item.categoryName}}</text>
        </view>
        <view class="budget-amounts">
          <text class="used-amount">{{item.usedAmount}}</text>
          <text class="budget-separator">/</text>
          <text class="total-amount">{{item.amount}}</text>
        </view>
      </view>
      <view class="budget-progress">
        <view class="progress-bar">
          <view class="progress-fill {{item.isOverBudget ? 'over-budget' : ''}}" 
                style="width: {{Math.min(item.usagePercentage, 100)}}%"></view>
        </view>
        <text class="progress-text {{item.isOverBudget ? 'over-budget' : ''}}">
          {{item.usagePercentage}}%
        </text>
      </view>
    </view>
  </view>
</view>

<!-- 时间选择弹窗 -->
<view class="time-picker-modal" wx:if="{{showTimePicker}}">
  <view class="modal-mask" bindtap="hideTimePicker"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">选择{{timeType === 'month' ? '月份' : '年份'}}</text>
      <text class="modal-close" bindtap="hideTimePicker">×</text>
    </view>
    <picker-view class="time-picker-view" value="{{timePickerValue}}" bindchange="onTimePickerChange">
      <picker-view-column wx:if="{{timeType === 'month'}}">
        <view wx:for="{{years}}" wx:key="*this" class="picker-item">{{item}}年</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{timeType === 'month' ? months : years}}" wx:key="*this" class="picker-item">
          {{timeType === 'month' ? item + '月' : item + '年'}}
        </view>
      </picker-view-column>
    </picker-view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideTimePicker">取消</button>
      <button class="btn btn-primary" bindtap="confirmTimePicker">确定</button>
    </view>
  </view>
</view>