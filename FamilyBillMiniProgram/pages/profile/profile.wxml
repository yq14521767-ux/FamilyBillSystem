<!--pages/profile/profile.wxml-->
<view class="container">
  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card card">
    <view class="user-header">
      <image 
        class="user-avatar" 
        src="{{userInfo.avatarDisplayUrl || '/images/user.png'}}" 
        mode="aspectFill" 
        bindtap="changeAvatar"
        binderror="onAvatarLoadError"
      ></image>
      <view class="user-info" bindtap="goToProfileDetail">
        <text class="user-name">{{userInfo.nickname || (userInfo.email ? userInfo.email.split('@')[0] : 'ç”¨æˆ·')}}</text>
        <text class="user-email" wx:if="{{userInfo.email}}">{{userInfo.email}}</text>
        <text class="join-date">åŠ å…¥æ—¶é—´ï¼š{{joinDate}}</text>
      </view>
      <view class="edit-profile" bindtap="editProfile">
        <text class="edit-text">ç¼–è¾‘</text>
      </view>
    </view>
  </view>

  <!-- æ•°æ®ç»Ÿè®¡ -->
  <view class="stats-card card">
    <text class="card-title">æˆ‘çš„æ•°æ®</text>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{userStats.totalBills}}</text>
        <text class="stat-label">æ€»è´¦å•æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{userStats.totalFamilies}}</text>
        <text class="stat-label">å‚ä¸å®¶åº­</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{userStats.thisMonthBills}}</text>
        <text class="stat-label">æœ¬æœˆè´¦å•</text>
      </view>
      <view class="stat-item">
        <text class="stat-value amount-expense">{{userStats.thisMonthAmount}}</text>
        <text class="stat-label">æœ¬æœˆæ¶ˆè´¹é‡‘é¢</text>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½èœå• -->
  <view class="menu-section">
    <!-- è´¦å•ç®¡ç† -->
    <view class="menu-group card">
      <text class="group-title">è´¦å•ç®¡ç†</text>
      <view class="menu-item" bindtap="goToCategories">
        <view class="menu-icon categories-icon">ğŸ“</view>
        <text class="menu-text">åˆ†ç±»ç®¡ç†</text>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="goToBudget">
        <view class="menu-icon budget-icon">ğŸ’°</view>
        <text class="menu-text">é¢„ç®—è®¾ç½®</text>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="exportData">
        <view class="menu-icon export-icon">ğŸ“Š</view>
        <text class="menu-text">æ•°æ®å¯¼å‡º</text>
        <text class="menu-arrow">></text>
      </view>
    </view>

    <!-- ç³»ç»Ÿè®¾ç½® -->
    <view class="menu-group card">
      <text class="group-title">ç³»ç»Ÿè®¾ç½®</text>
      <view class="menu-item" bindtap="goToNotifications">
        <view class="menu-icon notifications-icon">ğŸ””</view>
        <text class="menu-text">æ¶ˆæ¯ä¸­å¿ƒ</text>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="goToSettings">
        <view class="menu-icon settings-icon">âš™ï¸</view>
        <text class="menu-text">åº”ç”¨è®¾ç½®</text>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="goToHelp">
        <view class="menu-icon help-icon">â“</view>
        <text class="menu-text">å¸®åŠ©ä¸­å¿ƒ</text>
        <text class="menu-arrow">></text>
      </view>
      <view class="menu-item" bindtap="goToAbout">
        <view class="menu-icon about-icon">â„¹ï¸</view>
        <text class="menu-text">å…³äºæˆ‘ä»¬</text>
        <text class="menu-arrow">></text>
      </view>
    </view>

    <!-- è´¦æˆ·æ“ä½œ -->
    <view class="menu-group card">
      <view class="menu-item" bindtap="logout">
        <view class="menu-icon logout-icon">ğŸšª</view>
        <text class="menu-text logout-text">é€€å‡ºç™»å½•</text>
        <text class="menu-arrow">></text>
      </view>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘èµ„æ–™å¼¹çª— -->
<view class="edit-profile-modal" wx:if="{{showEditProfile}}">
  <view class="modal-mask" bindtap="hideEditProfile"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘èµ„æ–™</text>
      <text class="modal-close" bindtap="hideEditProfile">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">æ˜µç§°</text>
        <input class="input-field" type="text" placeholder="è¯·è¾“å…¥æ˜µç§°" value="{{editForm.nickName}}" bindinput="onNickNameInput" maxlength="50" />
      </view>
      
      <view class="input-group">
        <text class="input-label">æ€§åˆ«</text>
        <picker 
          class="input-field" 
          mode="selector" 
          range="{{genderOptions}}" 
          range-key="name" 
          value="{{genderIndex}}" 
          bindchange="onGenderChange"
        >
          <view class="picker">
            {{genderOptions[genderIndex].name}}
          </view>
        </picker>
      </view>
      
      <view class="input-group">
        <text class="input-label">æ‰‹æœºå·</text>
        <input 
          class="input-field" 
          type="number" 
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·" 
          value="{{editForm.phone}}" 
          bindinput="onPhoneInput" 
          maxlength="11"
        />
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideEditProfile">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="saveProfile" disabled="{{saveLoading}}">
        {{saveLoading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
      </button>
    </view>
  </view>
</view>

<!-- æ•°æ®å¯¼å‡ºå¼¹çª— -->
<view class="export-modal" wx:if="{{showExportModal}}">
  <view class="modal-mask" bindtap="hideExportModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">æ•°æ®å¯¼å‡º</text>
      <text class="modal-close" bindtap="hideExportModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="export-options">
        <text class="option-title">å¯¼å‡ºèŒƒå›´</text>
        <view class="option-group">
          <view class="option-item {{exportForm.range === 'month' ? 'selected' : ''}}" bindtap="selectExportRange" data-range="month">
            <text class="option-text">æœ¬æœˆæ•°æ®</text>
          </view>
          <view class="option-item {{exportForm.range === 'year' ? 'selected' : ''}}" bindtap="selectExportRange" data-range="year">
            <text class="option-text">æœ¬å¹´æ•°æ®</text>
          </view>
          <view class="option-item {{exportForm.range === 'all' ? 'selected' : ''}}" bindtap="selectExportRange" data-range="all">
            <text class="option-text">å…¨éƒ¨æ•°æ®</text>
          </view>
        </view>
      </view>
      
      <view class="export-options">
        <text class="option-title">å¯¼å‡ºæ ¼å¼</text>
        <view class="option-group">
          <view class="option-item {{exportForm.format === 'excel' ? 'selected' : ''}}" bindtap="selectExportFormat" data-format="excel">
            <text class="option-text">Excelæ ¼å¼</text>
          </view>
          <view class="option-item {{exportForm.format === 'csv' ? 'selected' : ''}}" bindtap="selectExportFormat" data-format="csv">
            <text class="option-text">CSVæ ¼å¼</text>
          </view>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideExportModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmExport" disabled="{{exportLoading}}">
        {{exportLoading ? 'å¯¼å‡ºä¸­...' : 'å¼€å§‹å¯¼å‡º'}}
      </button>
    </view>
  </view>
</view>