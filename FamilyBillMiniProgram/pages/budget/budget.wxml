<!--pages/budget/budget.wxml-->
<view class="container">
  <!-- æ—¶é—´é€‰æ‹© -->
  <view class="time-selector card">
    <view class="time-display" bindtap="showTimePicker">
      <text class="time-text">{{timeText}}</text>
      <text class="time-arrow">â–¼</text>
    </view>
    <view class="family-selector" wx:if="{{families.length > 0}}">
      <picker mode="selector" range="{{families}}" range-key="name" value="{{selectedFamilyIndex}}" bindchange="onFamilyChange">
        <view class="family-display">
          <text class="family-label">å®¶åº­</text>
          <text class="family-name">{{selectedFamilyName}}</text>
          <text class="family-arrow">â–¼</text>
        </view>
      </picker>
    </view>
    <view class="budget-summary">
      <text class="summary-text">æ€»é¢„ç®—: {{totalBudget}} | å·²ç”¨: {{totalUsed}} | å‰©ä½™: {{totalRemaining}}</text>
    </view>
  </view>

  <!-- é¢„ç®—åˆ—è¡¨ -->
  <view class="budget-list">
    <view class="budget-item card" wx:for="{{budgets}}" wx:key="id">
      <view class="budget-header">
        <view class="category-info">
          <view class="category-icon" style="background-color: {{item.category.color}}">
            {{item.category.icon || item.category.name.charAt(0)}}
          </view>
          <text class="category-name">{{item.category.name}}</text>
        </view>
        <view class="budget-actions">
          <text class="edit-btn" bindtap="editBudget" data-budget="{{item}}">ç¼–è¾‘</text>
          <text class="delete-btn" bindtap="deleteBudget" data-id="{{item.id}}">åˆ é™¤</text>
        </view>
      </view>
      
      <view class="budget-content">
        <view class="budget-amounts">
          <view class="amount-item">
            <text class="amount-label">é¢„ç®—é‡‘é¢</text>
            <text class="amount-value">{{item.amount}}</text>
          </view>
          <view class="amount-item">
            <text class="amount-label">å·²ä½¿ç”¨</text>
            <text class="amount-value amount-expense">{{item.usedAmount}}</text>
          </view>
          <view class="amount-item">
            <text class="amount-label">å‰©ä½™</text>
            <text class="amount-value {{item.remaining >= 0 ? 'amount-income' : 'amount-expense'}}">
              {{item.remaining}}
            </text>
          </view>
        </view>
        
        <view class="budget-progress">
          <view class="progress-bar">
            <view class="progress-fill {{item.isOverBudget ? 'over-budget' : ''}}" 
                  style="width: {{Math.min(item.usagePercentage, 100)}}%"></view>
          </view>
          <text class="progress-text {{item.isOverBudget ? 'over-budget' : ''}}">
            {{item.usagePercentage}}%
          </text>
        </view>
        
        <view class="budget-status" wx:if="{{item.isOverBudget}}">
          <text class="status-text over-budget">âš ï¸ é¢„ç®—è¶…æ”¯</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-budget" wx:if="{{budgets.length === 0}}">
      <view class="empty-icon">ğŸ’°</view>
      <text class="empty-text">æš‚æ— é¢„ç®—è®¾ç½®</text>
      <button class="btn btn-primary" bindtap="showAddBudgetModal">æ·»åŠ é¢„ç®—</button>
    </view>
  </view>

  <!-- æ·»åŠ é¢„ç®—æŒ‰é’® -->
  <view class="add-budget-btn" wx:if="{{budgets.length > 0}}" bindtap="showAddBudgetModal">
    <text class="add-icon">+</text>
  </view>
</view>

<!-- æ—¶é—´é€‰æ‹©å¼¹çª— -->
<view class="time-picker-modal" wx:if="{{showTimePicker}}">
  <view class="modal-mask" bindtap="hideTimePicker"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©æœˆä»½</text>
      <text class="modal-close" bindtap="hideTimePicker">Ã—</text>
    </view>
    <picker-view class="time-picker-view" value="{{timePickerValue}}" bindchange="onTimePickerChange">
      <picker-view-column>
        <view wx:for="{{years}}" wx:key="*this" class="picker-item">{{item}}å¹´</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{months}}" wx:key="*this" class="picker-item">{{item}}æœˆ</view>
      </picker-view-column>
    </picker-view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideTimePicker">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmTimePicker">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- æ·»åŠ /ç¼–è¾‘é¢„ç®—å¼¹çª— -->
<view class="budget-modal" wx:if="{{showBudgetModal}}">
  <view class="modal-mask" bindtap="hideBudgetModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">{{isEditMode ? 'ç¼–è¾‘é¢„ç®—' : 'æ·»åŠ é¢„ç®—'}}</text>
      <text class="modal-close" bindtap="hideBudgetModal">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="input-group">
        <text class="input-label">é€‰æ‹©åˆ†ç±»</text>
        <view class="category-selector" bindtap="showCategoryPicker">
          <view class="selected-category" wx:if="{{budgetForm.categoryId}}">
            <view class="category-icon" style="background-color: {{selectedCategory.color}}">
              {{selectedCategory.icon || selectedCategory.name.charAt(0)}}
            </view>
            <text class="category-name">{{selectedCategory.name}}</text>
          </view>
          <text class="placeholder" wx:else>è¯·é€‰æ‹©åˆ†ç±»</text>
          <text class="selector-arrow">></text>
        </view>
      </view>
      
      <view class="input-group">
        <text class="input-label">é¢„ç®—é‡‘é¢</text>
        <input class="input-field" type="digit" placeholder="è¯·è¾“å…¥é¢„ç®—é‡‘é¢" value="{{budgetForm.amount}}" bindinput="onBudgetAmountInput" />
      </view>
      
      <view class="input-group">
        <text class="input-label">å¤‡æ³¨</text>
        <textarea class="input-textarea" placeholder="é¢„ç®—å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" value="{{budgetForm.description}}" bindinput="onBudgetDescriptionInput" maxlength="100"></textarea>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideBudgetModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="saveBudget" disabled="{{!budgetForm.categoryId || !budgetForm.amount || saveLoading}}">
        {{saveLoading ? (isEditMode ? 'ä¿å­˜ä¸­...' : 'æ·»åŠ ä¸­...') : (isEditMode ? 'ä¿å­˜' : 'æ·»åŠ ')}}
      </button>
    </view>
  </view>
</view>

<!-- åˆ†ç±»é€‰æ‹©å¼¹çª— -->
<view class="category-picker-modal" wx:if="{{showCategoryPicker}}">
  <view class="modal-mask" bindtap="hideCategoryPicker"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©åˆ†ç±»</text>
      <text class="modal-close" bindtap="hideCategoryPicker">Ã—</text>
    </view>
    
    <view class="modal-body">
      <view class="category-list">
        <view class="category-item {{item.id === budgetForm.categoryId ? 'selected' : ''}}" 
              wx:for="{{expenseCategories}}" wx:key="id"
              bindtap="selectCategory" data-category="{{item}}">
          <view class="category-icon" style="background-color: {{item.color}}">
            {{item.icon || item.name.charAt(0)}}
          </view>
          <text class="category-name">{{item.name}}</text>
          <text class="selected-mark" wx:if="{{item.id === budgetForm.categoryId}}">âœ“</text>
        </view>
      </view>
    </view>
    
    <view class="modal-footer">
      <button class="btn btn-primary" bindtap="hideCategoryPicker">ç¡®å®š</button>
    </view>
  </view>
</view>