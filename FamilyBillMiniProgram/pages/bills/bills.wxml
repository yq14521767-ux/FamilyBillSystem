<!--pages/bills/bills.wxml-->
<view class="container">
  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-item" bindtap="showDatePicker">
      <text class="filter-text">{{timeText}}</text>
      <text class="filter-arrow">â–¼</text>
    </view>
    <view class="filter-item" bindtap="showCategoryFilter">
      <text class="filter-text">{{selectedCategoryName}}</text>
      <text class="filter-arrow">â–¼</text>
    </view>
    <view class="filter-item" bindtap="showTypeFilter">
      <text class="filter-text">{{selectedTypeName}}</text>
      <text class="filter-arrow">â–¼</text>
    </view>
  </view>

  <!-- å®¶åº­é€‰æ‹© -->
  <view class="family-selector" wx:if="{{families.length > 0}}">
    <picker mode="selector" range="{{families}}" range-key="name" value="{{selectedFamilyIndex}}" bindchange="onFamilyChange">
      <view class="family-display">
        <text class="family-label">å®¶åº­</text>
        <text class="family-name">{{selectedFamilyName}}</text>
        <text class="family-arrow">â–¼</text>
      </view>
    </picker>
  </view>

  <!-- æœˆåº¦ç»Ÿè®¡ -->
  <view class="month-stats card">
    <view class="stats-row">
      <view class="stat-item">
        <text class="stat-label">æ”¶å…¥</text>
        <text class="stat-value amount-income">+{{monthStats.income}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">æ”¯å‡º</text>
        <text class="stat-value amount-expense">-{{monthStats.expense}}</text>
      </view>
      <view class="stat-item">
        <text class="stat-label">ç»“ä½™</text>
        <text class="stat-value {{monthStats.balance >= 0 ? 'amount-income' : 'amount-expense'}}">{{monthStats.balance >= 0 ? '+' : ''}}{{monthStats.balance}}</text>
      </view>
    </view>
  </view>

  <!-- è´¦å•åˆ—è¡¨ -->
  <view class="bills-container">
    <view class="bill-group" wx:for="{{billGroups}}" wx:key="date">
      <view class="group-header">
        <text class="group-date">{{item.date}}</text>
        <text class="group-amount {{item.totalAmount >= 0 ? 'amount-income' : 'amount-expense'}}">
          {{item.totalAmount >= 0 ? '+' : ''}}{{item.totalAmount}}
        </text>
      </view>
      
      <view class="bill-list">
        <view class="bill-item" wx:for="{{item.bills}}" wx:key="id" wx:for-item="bill" bindtap="viewBillDetail" data-bill="{{bill}}">
          <view class="bill-icon" style="background-color: {{bill.categoryColor}}">
            {{bill.categoryIcon || bill.categoryName.charAt(0)}}
          </view>
          <view class="bill-content">
            <text class="bill-category">{{bill.categoryName}}</text>
            <text class="bill-description" wx:if="{{bill.description}}">{{bill.description}}</text>
          </view>
          <view class="bill-amount">
            <text class="amount {{bill.categoryType === 1 ? 'amount-income' : 'amount-expense'}}">
              {{bill.categoryType === 1 ? '+' : '-'}}{{bill.amount}}
            </text>
          </view>
          <view class="bill-actions" catchtap="showBillActions" data-bill="{{bill}}">
            <text class="action-icon">â‹¯</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && !loading}}">
      <button class="btn btn-secondary btn-small" bindtap="loadMore">åŠ è½½æ›´å¤š</button>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{billGroups.length === 0 && !loading}}">
      <view class="empty-state-icon">ğŸ“</view>
      <text class="empty-state-text">æš‚æ— è´¦å•è®°å½•</text>
      <button class="btn btn-primary btn-small" bindtap="addBill">ç«‹å³è®°è´¦</button>
    </view>
  </view>
</view>

<!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
<view class="fab" bindtap="addBill">
  <text class="fab-icon">+</text>
</view>

<!-- æ—¥æœŸé€‰æ‹©å¼¹çª— -->
<view class="date-picker-modal" wx:if="{{showDatePicker}}">
  <view class="modal-mask" bindtap="hideDatePicker"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©æœˆä»½</text>
      <text class="modal-close" bindtap="hideDatePicker">Ã—</text>
    </view>
    <picker-view class="date-picker" value="{{datePickerValue}}" bindchange="onDatePickerChange">
      <picker-view-column>
        <view wx:for="{{years}}" wx:key="*this" class="picker-item">{{item}}å¹´</view>
      </picker-view-column>
      <picker-view-column>
        <view wx:for="{{months}}" wx:key="*this" class="picker-item">{{item}}æœˆ</view>
      </picker-view-column>
    </picker-view>
    <view class="modal-footer">
      <button class="btn btn-secondary" bindtap="hideDatePicker">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmDatePicker">ç¡®å®š</button>
    </view>
  </view>
</view>

<!-- åˆ†ç±»ç­›é€‰å¼¹çª— -->
<view class="category-filter-modal" wx:if="{{showCategoryFilter}}">
  <view class="modal-mask" bindtap="hideCategoryFilter"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©åˆ†ç±»</text>
      <text class="modal-close" bindtap="hideCategoryFilter">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="category-list">
        <view class="category-item {{selectedCategoryId === null ? 'selected' : ''}}" bindtap="selectCategoryFilter" data-id="{{null}}">
          <text class="category-name">å…¨éƒ¨åˆ†ç±»</text>
        </view>
        <view class="category-item {{selectedCategoryId === item.id ? 'selected' : ''}}" 
              wx:for="{{categories}}" wx:key="id" 
              bindtap="selectCategoryFilter" data-id="{{item.id}}" data-name="{{item.name}}">
          <view class="category-icon" style="background-color: {{item.color}}">
            {{item.icon || item.name.charAt(0)}}
          </view>
          <text class="category-name">{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- ç±»å‹ç­›é€‰å¼¹çª— -->
<view class="type-filter-modal" wx:if="{{showTypeFilter}}">
  <view class="modal-mask" bindtap="hideTypeFilter"></view>
  <view class="modal-content">
    <view class="modal-header">
      <text class="modal-title">é€‰æ‹©ç±»å‹</text>
      <text class="modal-close" bindtap="hideTypeFilter">Ã—</text>
    </view>
    <view class="modal-body">
      <view class="type-list">
        <view class="type-item {{selectedType === null ? 'selected' : ''}}" bindtap="selectTypeFilter" data-type="{{null}}">
          <text class="type-name">å…¨éƒ¨</text>
        </view>
        <view class="type-item {{selectedType === 1 ? 'selected' : ''}}" bindtap="selectTypeFilter" data-type="{{1}}">
          <text class="type-name">æ”¶å…¥</text>
        </view>
        <view class="type-item {{selectedType === 2 ? 'selected' : ''}}" bindtap="selectTypeFilter" data-type="{{2}}">
          <text class="type-name">æ”¯å‡º</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- è´¦å•æ“ä½œå¼¹çª— -->
<view class="bill-actions-modal" wx:if="{{showBillActions}}">
  <view class="modal-mask" bindtap="hideBillActions"></view>
  <view class="actions-content">
    <view class="action-item" bindtap="editBill">
      <text class="action-text">ç¼–è¾‘</text>
    </view>
    <view class="action-item danger" bindtap="deleteBill">
      <text class="action-text">åˆ é™¤</text>
    </view>
    <view class="action-item" bindtap="hideBillActions">
      <text class="action-text">å–æ¶ˆ</text>
    </view>
  </view>
</view>